<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo de Integraci√≥n - Payment Emulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .payment-option {
            border: 2px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        .payment-option.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .cancel {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .iframe-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõí Demo de E-commerce - Payment Emulator</h1>
        
        <div class="info">
            <strong>üí° Instrucciones:</strong>
            <ol>
                <li>Primero inicia el payment emulator: <code>./payment-emulator start</code></li>
                <li>Selecciona un m√©todo de pago</li>
                <li>Haz clic en "Procesar Pago"</li>
                <li>En el emulador, simula el resultado deseado</li>
                <li>Ve c√≥mo tu app maneja la respuesta</li>
            </ol>
        </div>

        <h2>üí≥ Selecciona M√©todo de Pago</h2>
        
        <div class="payment-option" onclick="selectPayment('bancard')">
            <h3>üè¶ Bancard VPOS</h3>
            <p>Tarjetas de cr√©dito y d√©bito ‚Ä¢ Iframe ‚Ä¢ Puerto 8001</p>
            <small>Ejemplo: /vpos/api/0.3/single_buy</small>
        </div>

        <div class="payment-option" onclick="selectPayment('pagopar')">
            <h3>üì± Pagopar</h3>
            <p>Pagos digitales ‚Ä¢ Popup ‚Ä¢ Puerto 8002</p>
            <small>Ejemplo: /api/comercios/charges</small>
        </div>

        <h2>üõçÔ∏è Informaci√≥n del Pedido</h2>
        <p><strong>Producto:</strong> Laptop Gaming XYZ</p>
        <p><strong>Monto:</strong> ‚Ç≤ 15.000.000</p>
        <p><strong>Orden ID:</strong> <span id="orderId">ORD-2024-001</span></p>

        <div style="margin-top: 30px;">
            <button id="processBtn" onclick="processPayment()" disabled>
                üí∞ Procesar Pago
            </button>
            <button onclick="resetDemo()">üîÑ Reiniciar Demo</button>
        </div>

        <div id="result" class="result"></div>
        
        <iframe id="paymentFrame" class="iframe-container"></iframe>
    </div>

    <script>
        let selectedPayment = null;
        const orderId = 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('orderId').textContent = orderId;

        function selectPayment(method) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Seleccionar nuevo m√©todo
            event.target.closest('.payment-option').classList.add('selected');
            selectedPayment = method;
            document.getElementById('processBtn').disabled = false;
        }

        function processPayment() {
            if (!selectedPayment) return;

            const amount = 15000000;
            const successUrl = window.location.origin + window.location.pathname + '?status=success';
            const cancelUrl = window.location.origin + window.location.pathname + '?status=cancel';
            
            hideResult();

            if (selectedPayment === 'bancard') {
                // Bancard usa iframe
                const url = `http://localhost:8001/vpos/api/0.3/single_buy?` +
                    `amount=${amount}&` +
                    `order_id=${orderId}&` +
                    `return_url=${encodeURIComponent(successUrl)}&` +
                    `cancel_url=${encodeURIComponent(cancelUrl)}`;
                
                const iframe = document.getElementById('paymentFrame');
                iframe.src = url;
                iframe.style.display = 'block';
                
                // Escuchar cambios en la URL para detectar redirecci√≥n
                iframe.onload = function() {
                    try {
                        const iframeUrl = iframe.contentWindow.location.href;
                        if (iframeUrl.includes('status=')) {
                            handlePaymentResult(iframeUrl);
                        }
                    } catch (e) {
                        // Cross-origin restrictions
                    }
                };

            } else if (selectedPayment === 'pagopar') {
                // Pagopar usa popup
                const url = `http://localhost:8002/api/comercios/charges?` +
                    `amount=${amount}&` +
                    `order_id=${orderId}&` +
                    `callback_url=${encodeURIComponent(successUrl)}`;
                
                const popup = window.open(url, 'pagopar', 'width=500,height=600');
                
                // Escuchar mensajes del popup
                window.addEventListener('message', function(event) {
                    if (event.origin === 'http://localhost:8002') {
                        handlePaymentResult(null, event.data);
                        popup.close();
                    }
                });
            }
        }

        function handlePaymentResult(url, data) {
            const iframe = document.getElementById('paymentFrame');
            iframe.style.display = 'none';
            
            let status, transactionId, errorCode, errorMessage;
            
            if (url) {
                // Parsear URL
                const urlParams = new URLSearchParams(url.split('?')[1]);
                status = urlParams.get('status');
                transactionId = urlParams.get('transaction_id');
                errorCode = urlParams.get('error_code');
                errorMessage = urlParams.get('error_message');
            } else if (data) {
                // Usar datos del mensaje
                status = data.status;
                transactionId = data.transaction_id;
                errorCode = data.error_code;
                errorMessage = data.error_message;
            }

            showResult(status, transactionId, errorCode, errorMessage);
        }

        function showResult(status, transactionId, errorCode, errorMessage) {
            const resultDiv = document.getElementById('result');
            let html = '';
            
            if (status === 'success') {
                resultDiv.className = 'result success';
                html = `
                    <h3>‚úÖ Pago Exitoso</h3>
                    <p><strong>Transaction ID:</strong> ${transactionId}</p>
                    <p><strong>Orden:</strong> ${orderId}</p>
                    <p><strong>Monto:</strong> ‚Ç≤ 15.000.000</p>
                    <p>El pago se ha procesado correctamente.</p>
                `;
            } else if (status === 'error') {
                resultDiv.className = 'result error';
                html = `
                    <h3>‚ùå Error en el Pago</h3>
                    <p><strong>C√≥digo de Error:</strong> ${errorCode}</p>
                    <p><strong>Mensaje:</strong> ${decodeURIComponent(errorMessage || 'Error desconocido')}</p>
                    <p>Por favor, intenta nuevamente o contacta soporte.</p>
                `;
            } else if (status === 'cancelled') {
                resultDiv.className = 'result cancel';
                html = `
                    <h3>üö´ Pago Cancelado</h3>
                    <p>El usuario cancel√≥ la transacci√≥n.</p>
                    <p>Puedes intentar nuevamente cuando desees.</p>
                `;
            } else {
                resultDiv.className = 'result error';
                html = `
                    <h3>‚ö†Ô∏è Estado Desconocido</h3>
                    <p><strong>Status:</strong> ${status}</p>
                    <p>Se recibi√≥ un estado no reconocido.</p>
                `;
            }
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }

        function resetDemo() {
            selectedPayment = null;
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('processBtn').disabled = true;
            document.getElementById('paymentFrame').style.display = 'none';
            hideResult();
        }

        // Manejar par√°metros de URL para simular callback
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            
            if (status) {
                const transactionId = urlParams.get('transaction_id');
                const errorCode = urlParams.get('error_code');
                const errorMessage = urlParams.get('error_message');
                
                showResult(status, transactionId, errorCode, errorMessage);
                
                // Limpiar URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>